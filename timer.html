<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Structure Creator</title>
</head>
<body>
    <div class="container">
        <h1>Custom Timer Structure</h1>

        <div id="timerBuilder"></div>
        
        <button onclick="generateStructure()">Generate Structure</button>
        <button onclick="loadStructure()">Load Structure</button>

        <h2>JSON Structure:</h2>
        <textarea id="jsonInput" placeholder="Enter or view JSON structure here" rows="10" style="width: 100%;"></textarea>
        <div id="errorMessage" style="color: red; margin-top: 5px;"></div>
    </div>

    <script>
        let rootTimer = {
            name: "Custom Timer",
            duration: "",
            timers: []
        };

        function addTimer(parent = rootTimer) {
            const timer = {
                name: "",
                duration: "",
                repetitions: "",
                timers: []
            };
            parent.duration = "";
            parent.timers.push(timer);
            renderTimers(rootTimer, document.getElementById("timerBuilder"));
        }

        function addSubTimer(timer) {
            const subTimer = {
                name: "",
                duration: "",
                repetitions: "",
                timers: []
            };
            timer.duration = "";
            timer.timers.push(subTimer);
            renderTimers(rootTimer, document.getElementById("timerBuilder"));
        }

        function deleteTimer(parent, timerIndex) {
            parent.timers.splice(timerIndex, 1);
            renderTimers(rootTimer, document.getElementById("timerBuilder"));
        }

        function renderTimers(timer, container, parent = null, index = null) {
            container.innerHTML = "";
            const mainDiv = document.createElement("div");
            mainDiv.className = "timer-block";

            // "×" delete button for each timer
            if (parent !== null && index !== null) {
                const deleteButton = document.createElement("span");
                deleteButton.className = "delete-button";
                deleteButton.innerText = "×";
                deleteButton.onclick = () => deleteTimer(parent, index);
                mainDiv.appendChild(deleteButton);
            }

            // Timer name input
            const nameInput = document.createElement("input");
            nameInput.placeholder = "Name";
            nameInput.value = timer.name || "";
            nameInput.required = true;
            nameInput.oninput = (e) => (timer.name = e.target.value);

            // Duration input
            const durationInput = document.createElement("input");
            durationInput.placeholder = "Duration HH:MM:SS";
            durationInput.value = timer.duration || "";
            durationInput.oninput = (e) => (timer.duration = e.target.value);
            durationInput.disabled = timer.timers && timer.timers.length > 0;

            // Repetitions input
            const repetitionsInput = document.createElement("input");
            repetitionsInput.placeholder = "Repetitions";
            repetitionsInput.type = "number";
            repetitionsInput.value = timer.repetitions || "";
            repetitionsInput.min = 2;
            repetitionsInput.oninput = (e) => (timer.repetitions = e.target.value);

            mainDiv.append(nameInput, durationInput, repetitionsInput);
        
            // List of sub-timers
            const timerList = document.createElement("div");
            timerList.className = "timer-list";
            if (timer.timers) {
                timer.timers.forEach((subTimer, subIndex) => {
                    const subTimerContainer = document.createElement("div");
                    subTimerContainer.className = "sub-timer";
                    renderTimers(subTimer, subTimerContainer, timer, subIndex);
                    timerList.appendChild(subTimerContainer);
                });
            }
            mainDiv.appendChild(timerList);

            // Add sub-timer button
            const addSubTimerButton = document.createElement("button");
            addSubTimerButton.innerText = "Add Timer";
            addSubTimerButton.onclick = () => timer !== rootTimer ? addSubTimer(timer) : addTimer();
            mainDiv.appendChild(addSubTimerButton);

            if (timer.timers && timer.timers.length > 0) {
                // Collapse/Expand button for sub-timers
                const toggleButton = document.createElement("button");
                toggleButton.innerText = "Hide Sub-timers";
                toggleButton.onclick = () => {
                    timerList.style.display = timerList.style.display === "none" ? "block" : "none";
                    toggleButton.innerText = timerList.style.display === "none" ? "Show Sub-timers" : "Hide Sub-timers";
                };
                mainDiv.appendChild(toggleButton);
            }

            container.appendChild(mainDiv);
        }

        function cleanUpTimer(timer) {
            const cleanedTimer = { name: timer.name };

            if (timer.duration && timer.timers.length > 0) {
                console.log(`${timer.name} cannot have both duration and sub-timers together`);
                delete timer.duration;
            }
            if (timer.duration) cleanedTimer.duration = timer.duration;
            if (timer.repetitions && timer.repetitions > 1) cleanedTimer.repetitions = timer.repetitions;

            if (timer.timers && timer.timers.length > 0) {
                cleanedTimer.timers = timer.timers.map(cleanUpTimer);
            }

            return cleanedTimer;
        }

        function generateStructure() {
            const cleanedRoot = cleanUpTimer(rootTimer);
            document.getElementById("jsonInput").value = JSON.stringify(cleanedRoot, null, 2);
            document.getElementById("errorMessage").innerText = ""; // Clear error message
        }

        function validateTimerStructure(timer) {
            if (!timer.name) timer.name = "Unnamed Timer";
            if (!timer.duration) timer.duration = "";
            if (!timer.repetitions) timer.repetitions = "";
            if (!Array.isArray(timer.timers)) timer.timers = [];
            timer.timers.forEach(validateTimerStructure);
        }

        function loadStructure() {
            const jsonInput = document.getElementById("jsonInput").value;
            const errorMessageElement = document.getElementById("errorMessage");
            try {
                const parsedStructure = JSON.parse(jsonInput);
                validateTimerStructure(parsedStructure);
                rootTimer = parsedStructure;
                renderTimers(rootTimer, document.getElementById("timerBuilder"));
                errorMessageElement.innerText = ""; // Clear any previous error message
            } catch (error) {
                errorMessageElement.innerText = "Invalid JSON structure. Please try again.";
                console.error("JSON Parse Error:", error);
            }
        }

        // Initialize root timer UI
        renderTimers(rootTimer, document.getElementById("timerBuilder"));
    </script>

    <style>
        .container { max-width: 600px; margin: auto; padding: 20px; }
        .timer-block { position: relative; margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .timer-list { padding-left: 20px; }
        .sub-timer { margin-top: 5px; padding-left: 15px; border-left: 1px dotted #ccc; }
        .delete-button { position: absolute; top: 5px; right: 5px; cursor: pointer; color: red; font-weight: bold; }
        input { margin: 5px; padding: 5px; }
        button { margin: 5px; padding: 5px 10px; }
        textarea { margin-top: 10px; padding: 10px; }
    </style>
</body>
</html>
